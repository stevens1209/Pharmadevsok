<div class="container mt-4">

  <h1>Gestión de Producción</h1>

  <mat-form-field appearance="outline" class="filter-input">
    <mat-label>Buscar producción</mat-label>
    <input matInput (keyup)="buscarProduccion($event)" placeholder="Filtrar por cualquier campo...">
    <mat-icon matSuffix>search</mat-icon>
  </mat-form-field>

  <button mat-raised-button color="primary" (click)="abrirModalProduccion()">Nueva Producción</button>

  <div class="table-container" style="margin-top: 16px;">
    <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8">

      <!-- Detalles -->
      <ng-container matColumnDef="detalles">
        <th mat-header-cell *matHeaderCellDef> Detalles </th>
        <td mat-cell *matCellDef="let produccion">
          <button mat-icon-button color="accent" (click)="abrirModalDetalles(produccion)">
            <mat-icon>info</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- ID Producción -->
      <ng-container matColumnDef="idProuccion">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> ID </th>
        <td mat-cell *matCellDef="let produccion"> {{produccion.idProduccion}} </td>
      </ng-container>

      <!-- Fecha Producción -->
      <ng-container matColumnDef="Fechaproduccion">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha Producción </th>
        <td mat-cell *matCellDef="let produccion"> {{produccion.fechaproduccion | date:'dd/MM/yyyy'}} </td>
      </ng-container>

      <!-- Fecha Vencimiento -->
      <ng-container matColumnDef="Fechavencimiento">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha Vencimiento </th>
        <td mat-cell *matCellDef="let produccion"> {{produccion.fechavencimiento | date:'dd/MM/yyyy'}} </td>
      </ng-container>

      <!-- Lote -->
      <ng-container matColumnDef="Lote">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Lote </th>
        <td mat-cell *matCellDef="let produccion"> {{produccion.lote}} </td>
      </ng-container>

      <!-- Cantidad Producida -->
      <ng-container matColumnDef="Cantidadproducida">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Cantidad Producida </th>
        <td mat-cell *matCellDef="let produccion"> {{produccion.cantidadproducida}} </td>
      </ng-container>

      <!-- Producto -->
      <ng-container matColumnDef="producto">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Producto </th>
        <td mat-cell *matCellDef="let produccion"> {{produccion.producto?.nombre || 'N/A'}} </td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef> Acciones </th>
        <td mat-cell *matCellDef="let produccion">
          <button mat-icon-button color="primary" (click)="abrirModalProduccion(true, produccion)">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="delete(produccion)">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="mostrarColumnas"></tr>
      <tr mat-row *matRowDef="let row; columns: mostrarColumnas;"></tr>
    </table>

    <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
  </div>

  <!-- Modal Form Producción -->
  <ng-template #modalProduccion>
    <h2 mat-dialog-title>{{ editar ? 'Editar Producción' : 'Nueva Producción' }}</h2>
    <mat-dialog-content>
      <form #formProduccion="ngForm">

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Fecha Producción</mat-label>
          <input matInput [matDatepicker]="picker1" [(ngModel)]="produccion.fechaproduccion" name="fechaproduccion" required placeholder="Seleccione fecha de producción">
          <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
          <mat-datepicker #picker1></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Fecha Vencimiento</mat-label>
          <input matInput [matDatepicker]="picker2" [(ngModel)]="produccion.fechavencimiento" name="fechavencimiento" required placeholder="Seleccione fecha de vencimiento">
          <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
          <mat-datepicker #picker2></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Lote</mat-label>
          <input matInput [(ngModel)]="produccion.lote" name="lote" required maxlength="50" placeholder="Ingrese lote">
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Cantidad Producida</mat-label>
          <input matInput type="number" min="1" [(ngModel)]="produccion.cantidadproducida" name="cantidadproducida" required placeholder="Ingrese cantidad producida">
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Producto</mat-label>
          <mat-select [(ngModel)]="produccion.producto" name="producto" required>
            <mat-option *ngFor="let producto of productos" [value]="producto">
              {{producto.nombre}}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="full-width" style="margin-top: 15px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 500;">Imagen</label>
          <input type="file" (change)="onFileSelected($event)" accept="image/*" />
        </div>

        <div *ngIf="imagenPreview" style="margin-top: 10px;">
          <img [src]="imagenPreview" alt="Vista previa imagen" style="max-width: 200px; max-height: 150px; border-radius: 4px;" />
        </div>

      </form>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-button (click)="cancelarEdicion(formProduccion)">Cancelar</button>
      <button mat-flat-button color="primary" [disabled]="!formProduccion.form.valid" (click)="guardarProduccion()">Guardar</button>
    </mat-dialog-actions>
  </ng-template>

  <!-- Modal Detalles -->
  <ng-template #modalDetalles>
    <h2 mat-dialog-title>Detalles Producción</h2>
    <mat-dialog-content *ngIf="produccionSeleccionado">
      <p><strong>ID:</strong> {{produccionSeleccionado.idProduccion}}</p>
      <p><strong>Fecha Producción:</strong> {{produccionSeleccionado.fechaproduccion | date:'dd/MM/yyyy'}}</p>
      <p><strong>Fecha Vencimiento:</strong> {{produccionSeleccionado.fechavencimiento | date:'dd/MM/yyyy'}}</p>
      <p><strong>Lote:</strong> {{produccionSeleccionado.lote}}</p>
      <p><strong>Cantidad Producida:</strong> {{produccionSeleccionado.cantidadproducida}}</p>
      <p><strong>Producto:</strong> {{produccionSeleccionado.producto.nombre}}</p>

      <div *ngIf="produccionSeleccionado.imagen" style="margin-top: 15px;">
        <strong>Imagen:</strong><br />
        <img [src]="'http://localhost:8080/' + produccionSeleccionado.imagen" alt="Imagen producción" style="max-width: 300px; max-height: 200px; border-radius: 4px; margin-top: 8px;" />
      </div>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-button (click)="dialog.closeAll()">Cerrar</button>
    </mat-dialog-actions>
  </ng-template>

</div>
