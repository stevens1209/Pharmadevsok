<div class="container mt-4">
  <h1>Ventas</h1>

  <div class="d-flex justify-content-center mb-3">
    <button mat-raised-button color="primary" (click)="abrirModal()">
      <mat-icon>add</mat-icon>
      Agregar Venta
    </button>
  </div>

  <mat-form-field appearance="fill" class="w-100">
    <mat-label>Buscar</mat-label>
    <input matInput (keyup)="filtroVenta($event)" placeholder="Buscar Venta...">
  </mat-form-field>

  <div class="table-responsive">
    <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8 w-100">

      <!-- detalles -->
      <ng-container matColumnDef="detalles">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let v">
          <button mat-icon-button color="primary" (click)="abrirModalDetalles(v)">
            <mat-icon>visibility</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- idVentas -->
      <ng-container matColumnDef="idVentas">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
        <td mat-cell *matCellDef="let v">{{ v.idVentas }}</td>
      </ng-container>

      <!-- Fecha Venta -->
      <ng-container matColumnDef="fechaventa">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha de Venta</th>
        <td mat-cell *matCellDef="let v">{{ v.fechaventa | date }}</td>
      </ng-container>

      <!-- Forma de Pago -->
      <ng-container matColumnDef="formapago">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Forma de Pago</th>
        <td mat-cell *matCellDef="let v">{{ v.formapago }}</td>
      </ng-container>

      <!-- Total Venta -->
      <ng-container matColumnDef="totalventa">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Total Venta</th>
        <td mat-cell *matCellDef="let v">{{ v.totalventa | currency }}</td>
      </ng-container>

     
    
      

      <!-- Cliente -->
      <ng-container matColumnDef="cliente">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Cliente</th>
        <td mat-cell *matCellDef="let v">{{ v.cliente ? v.cliente.nombre : '' }}</td>
      </ng-container>

    

      <!-- Factura Venta ID -->
        <ng-container matColumnDef="facturaventa">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Factura Venta ID</th>
        <td mat-cell *matCellDef="let v">{{ v.facturaventa ? v.facturaventa.idFacturaventa : 'No disponible' }}</td>
        </ng-container>


      <!-- acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let v">
          <button class="btn btn-warning btn-sm me-1" (click)="abrirModal(v)">
            <mat-icon>edit</mat-icon>
          </button>
          <button class="btn btn-danger btn-sm" (click)="venta = v; delete()">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="mostrarColumnas"></tr>
      <tr mat-row *matRowDef="let row; columns: mostrarColumnas;"></tr>
    </table>

    <mat-paginator [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons></mat-paginator>
  </div>
</div>

<!-- Modal Crear/Editar -->
<ng-template #modalVenta>
  <mat-dialog-content>
    <h2 mat-dialog-title>{{ editar ? 'Editar Venta' : 'Agregar Venta' }}</h2>

    <form #formVenta="ngForm" novalidate>
      <div class="row">
        <div class="col-md-12 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Fecha de Venta</mat-label>
            <input matInput [matDatepicker]="picker" [(ngModel)]="venta.fechaventa" name="fechaventa" required>
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="col-md-12 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Forma de Pago</mat-label>
            <input matInput type="text" [(ngModel)]="venta.formapago" name="formapago" required>
          </mat-form-field>
        </div>

        <div class="col-md-12 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Total Venta</mat-label>
            <input matInput type="number" [(ngModel)]="venta.totalventa" name="totalventa" required>
          </mat-form-field>
        </div>

        <div class="col-md-12 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Cliente</mat-label>
            <mat-select [(ngModel)]="venta.cliente" name="cliente" required>
              <mat-option *ngFor="let c of (clientes || [])" [value]="c">
                {{ c.nombre }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancelar</button>
    <button mat-flat-button color="primary" (click)="guardarVenta(formVenta)" [disabled]="formVenta.invalid">
      {{ editar ? 'Actualizar' : 'Guardar' }}
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- Modal Detalles -->
<ng-template #modalDetalles let-data>
  <h2 mat-dialog-title>Detalle de Venta</h2>
  <mat-dialog-content>
    <p><strong>Fecha de Venta: </strong>{{ ventaSeleccionado?.fechaventa | date }}</p>
    <p><strong>Forma de Pago: </strong>{{ ventaSeleccionado?.formapago }}</p>
    <p><strong>Total Venta: </strong>
      <span>{{ ventaSeleccionado?.totalventa != null && ventaSeleccionado?.totalventa !== undefined ? ventaSeleccionado?.totalventa : 0 | currency }}</span>
    </p>
    <p><strong>Cliente: </strong>{{ ventaSeleccionado?.cliente?.nombre }}</p>
    <p><strong>Factura Venta ID:</strong>{{ ventaSeleccionado?.facturaventa?.['idFacturaVenta'] || 'No disponible'}}</p>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button (click)="cerrarModal()">Cerrar</button>
  </mat-dialog-actions>
</ng-template>

